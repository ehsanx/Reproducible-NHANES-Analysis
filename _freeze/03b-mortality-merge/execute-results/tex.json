{
  "hash": "8d7f139a7a5d519e11a2a4ed00647ca6",
  "result": {
    "markdown": "# Mortality and NHANES Merging\n\n---\n\nThis section continues the data preparation process. In the previous part, we created 10 cleaned datasets, one for each NHANES cycle from 1999 to 2018. Now, we will combine those 10 datasets into a single data frame and then link it with the all-cause mortality follow-up data from the National Death Index (NDI).\n\n\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/libraries_8a9f0865f6ecdfd6ee59dbdfe49461a1'}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(readr)\n```\n:::\n\n\n\n\n\n## Combining the NHANES Survey Cycles\n\n* R Code Chunk 1: Load Processed NHANES Data\n\nThe following code begins by loading the 10 processed `.RData` files that were created and saved in the previous section. Each file contains the cleaned demographic and smoking variables for participants aged 20 years and older for a specific survey cycle. The `ls()` command is used to list the objects now loaded in our R environment.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/reading_b90cd9b1de5b547dc294138a3a2fa927'}\n\n```{.r .cell-code}\nload(file=\"data/analytic00.RData\")\nload(file=\"data/analytic01.RData\")\nload(file=\"data/analytic03.RData\")\nload(file=\"data/analytic05.RData\")\nload(file=\"data/analytic07.RData\")\nload(file=\"data/analytic09.RData\")\nload(file=\"data/analytic11.RData\")\nload(file=\"data/analytic13.RData\")\nload(file=\"data/analytic15.RData\")\nload(file=\"data/analytic17.RData\")\nls()\n#>  [1] \"analytic00\"      \"analytic01\"      \"analytic03\"      \"analytic05\"     \n#>  [5] \"analytic07\"      \"analytic09\"      \"analytic11\"      \"analytic13\"     \n#>  [9] \"analytic15\"      \"analytic17\"      \"has_annotations\" \"nhanes00\"       \n#> [13] \"nhanes01\"        \"nhanes03\"        \"nhanes05\"        \"nhanes07\"       \n#> [17] \"nhanes09\"        \"nhanes11\"        \"nhanes13\"        \"nhanes15\"       \n#> [21] \"nhanes17\"\n```\n:::\n\n\n\n---\n\n* R Code Chunk 2: Combine NHANES Cycles and Adjust Weights\n\nNow that the 10 separate NHANES datasets are loaded into the environment, we need to combine them into one single data frame and adjust the survey weights for the pooled data.\n\n**1. Combine Datasets**\n\nThe following code combines the 10 individual analytic data frames into a single, large data frame named `dat.full`. The `rbind()` function is used to stack the data frames by row. After this step, we run several checks to confirm that all 10 survey cycles are present and to see the final dimensions of the combined dataset. There are now 101316 rows in the single dataframe.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/nhanesMerge_13b04cfebc8bb5acc0cf48ae4085ec32'}\n\n```{.r .cell-code}\n# Full dataset : 1999-2018\ndat.full <- rbind(nhanes00, nhanes01, nhanes03, nhanes05, \n                  nhanes07, nhanes09, nhanes11, \n                  nhanes13, nhanes15, nhanes17)\n\nunique(dat.full$year)\n#>  [1] NHANES 1999-2000 Public Release NHANES 2001-2002 Public Release\n#>  [3] NHANES 2003-2004 Public Release NHANES 2005-2006 Public Release\n#>  [5] NHANES 2007-2008 Public Release NHANES 2009-2010 Public Release\n#>  [7] NHANES 2011-2012 public release NHANES 2013-2014 public release\n#>  [9] NHANES 2015-2016 public release NHANES 2017-2018 public release\n#> 10 Levels: NHANES 1999-2000 Public Release ... NHANES 2017-2018 public release\nlength(unique(dat.full$year))\n#> [1] 10\ndim(dat.full)\n#> [1] 101316     12\n```\n:::\n\n\n\n**2. Adjust Survey Weights**\n\nNext, the following code adjusts the survey weights. When combining multiple NHANES cycles, the original two-year survey weights must be redistributed. We create a new weight variable, `survey.weight.new`, by dividing the original weight by the number of survey cycles (10). The original weight column is then removed.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/weight_variable_0361d627ef78cd6561a05234715bcd10'}\n\n```{.r .cell-code}\n# Corrected Weights\ndat.full$survey.weight.new <- dat.full$survey.weight / \n  length(unique(dat.full$year))\n\n# Remove original variable\ndat.full$survey.weight <- NULL\n\n# Print Columns\nnames(dat.full)\n#>  [1] \"id\"                 \"age\"                \"sex\"               \n#>  [4] \"race\"               \"born\"               \"smoking.age\"       \n#>  [7] \"smoked.while.child\" \"smoking\"            \"psu\"               \n#> [10] \"strata\"             \"year\"               \"survey.weight.new\"\n```\n:::\n\n\n\n---\n\n## Acquiring the Linked Mortality Data\n\n* R Code Chunk 3: Download and Read Mortality Data\n\nThis section covers downloading the public-use mortality data linked to the NHANES participants.\n\n**1. Create Data Directories**\n\nBefore downloading the data, we first ensure the necessary subdirectories (`data/` and `data/Mortalitydata/`) exist in our project folder for our computer's workspace. The following code checks for these directories and creates them if they are missing, which prevents errors when saving files.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/Dir_fad86c953edbc967aacce5002dcb7e0d'}\n\n```{.r .cell-code}\n# Create directories only if they don't exist\nif (!dir.exists(\"data\")) {\n  dir.create(\"data\")\n}\nif (!dir.exists(\"data/Mortalitydata\")) {\n  dir.create(\"data/Mortalitydata\")\n}\n```\n:::\n\n\n\n**2. Read Fixed-Width Format Files**\n\nThe public-use mortality data is provided by NCHS in a fixed-width text file format (.dat). In this format, each variable occupies a specific character position on each line. We need to read the file for each NHANES cycle and extract the necessary columns.\n\n\n\n::: {.cell layout-align=\"center\" hash='03b-mortality-merge_cache/pdf/image_7b5f612ef03cdcff4a6b37b4a918f34b'}\n::: {.cell-output-display}\n![](images/mortalityWeb.png){fig-align='center' width=70% height=40%}\n:::\n:::\n\n\n\nTo read this type of file, we use the `readr::read_fwf()` function. We must provide `fwf_cols()` with the exact start and end positions for each variable we want to extract, based on the official NCHS documentation.\n\nThe following code demonstrates this process for the 1999-2000 mortality file, reading it directly from the CDC's server by copying the link (shown in image). For this tutorial, this same process was repeated for all 10 survey cycles. \n\n### Mortality data 1999-2000\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2000_6075762f87ed48bea370d7aa3abe1b92'}\n\n```{.r .cell-code}\nmort2000 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_1999_2000_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\ncolnames(mort2000)\n#> [1] \"id\"                \"mort_eligstat\"     \"mort_stat\"        \n#> [4] \"mort_ucod_leading\" \"mort_diabetes\"     \"mort_hyperten\"    \n#> [7] \"mort_permth_int\"   \"mort_permth_exm\"\nhead(mort2000)\n#> # A tibble: 6 x 8\n#>      id mort_eligstat mort_stat mort_ucod_leading mort_diabetes mort_hyperten\n#>   <int>         <int>     <int>             <int>         <int>         <int>\n#> 1     1             2        NA                NA            NA            NA\n#> 2     2             1         1                 6             0             0\n#> 3     3             2        NA                NA            NA            NA\n#> 4     4             2        NA                NA            NA            NA\n#> 5     5             1         0                NA            NA            NA\n#> 6     6             1         0                NA            NA            NA\n#> # i 2 more variables: mort_permth_int <int>, mort_permth_exm <int>\n```\n:::\n\n\n\n### Mortality data 2001-2002\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2001_daa0303235d55002e3bd7c249a9b2268'}\n\n```{.r .cell-code}\nmort2001 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2001_2002_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n#colnames(mort2001)\n#head(mort2001)\n```\n:::\n\n\n\n### Mortality data 2003-2004\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2003_81d1c03178f6d5d802d1ffd693a3fb48'}\n\n```{.r .cell-code}\nmort2003 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2003_2004_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2003)\n#head(mort2003)\n```\n:::\n\n\n\n### Mortality data 2005-2006\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2005_d0e9b8e72e7d9c76a13f38572ad863bd'}\n\n```{.r .cell-code}\nmort2005 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2005_2006_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2005)\n#head(mort2005)\n```\n:::\n\n\n\n### Mortality data 2007-2008\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2007_c939a6a79aaeb72f2c506cc96a7c7249'}\n\n```{.r .cell-code}\nmort2007 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2007_2008_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2007)\n#head(mort2007)\n```\n:::\n\n\n\n### Mortality data 2009-2010\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2009_218cda468b03e73733b7e126b1b1ecdf'}\n\n```{.r .cell-code}\nmort2009 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2009_2010_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2009)\n#head(mort2009)\n```\n:::\n\n\n\n### Mortality data 2011-2012\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2011_25663dd1620ed71ff8ded016bea5353b'}\n\n```{.r .cell-code}\nmort2011 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2011_2012_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2011)\n#head(mort2011)\n```\n:::\n\n\n\n### Mortality data 2013-2014\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2013_885982b6c49d9c7d5d7d773fd68a8a67'}\n\n```{.r .cell-code}\nmort2013 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2013_2014_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2013)\n#head(mort2013)\n```\n:::\n\n\n\n### Mortality data 2015-2016\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2015_63b904776a5689a57600e285514a78aa'}\n\n```{.r .cell-code}\nmort2015 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2015_2016_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2015)\n#head(mort2015)\n```\n:::\n\n\n\n### Mortality data 2017-2018\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mort2017_d7e45d0b61cf3e89cd673c07d2c16c72'}\n\n```{.r .cell-code}\nmort2017 <- read_fwf(file = \"https://ftp.cdc.gov/pub/Health_Statistics/NCHS/datalinkage/linked_mortality/NHANES_2017_2018_MORT_2019_PUBLIC.dat\",\n                     col_types = \"iiiiiiii\",\n                     fwf_cols(id = c(1,6),\n                              mort_eligstat = c(15,15),\n                              mort_stat = c(16,16),\n                              mort_ucod_leading = c(17,19),\n                              mort_diabetes = c(20,20),\n                              mort_hyperten = c(21,21),\n                              mort_permth_int = c(43,45),\n                              mort_permth_exm = c(46,48)),\n                     na = c(\"\", \".\"))\n\n#colnames(mort2017)\n#head(mort2017)\n```\n:::\n\n\n\nAfter downloading, each of the 10 mortality data frames is saved as an `.RData` file.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/saveMort_2a4b81d54d6cccffc2997fe4770e6981'}\n\n```{.r .cell-code}\nsaveRDS(mort2000, file = \"data/Mortalitydata/mort2000.RData\")\nsaveRDS(mort2001, file = \"data/Mortalitydata/mort2001.RData\")\nsaveRDS(mort2003, file = \"data/Mortalitydata/mort2003.RData\")\nsaveRDS(mort2005, file = \"data/Mortalitydata/mort2005.RData\")\nsaveRDS(mort2007, file = \"data/Mortalitydata/mort2007.RData\")\nsaveRDS(mort2009, file = \"data/Mortalitydata/mort2009.RData\")\nsaveRDS(mort2011, file = \"data/Mortalitydata/mort2011.RData\")\nsaveRDS(mort2013, file = \"data/Mortalitydata/mort2013.RData\")\nsaveRDS(mort2015, file = \"data/Mortalitydata/mort2015.RData\")\nsaveRDS(mort2017, file = \"data/Mortalitydata/mort2017.RData\")\n```\n:::\n\n\n\n---\n\n## Merging NHANES with Mortality Data\n\n* R Code Chunk 4: Combine Mortality Datasets\n\nThe following code combines the 10 individual mortality data frames into a single, large data frame named `dat.mortality`. The `rbind()` function is used to combine the data frames vertically by stacking rows. The `dim()` and `head()` functions are then used to confirm the dimensions and inspect the first few rows of the combined dataset. There are 101,316 rows in the dataset.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/mortMerge_dc5847e48481b95934c8ae57b87eb4a4'}\n\n```{.r .cell-code}\ndat.mortality <- rbind(mort2000, mort2001, mort2003, mort2005, \n                       mort2007, mort2009, mort2011, \n                       mort2013, mort2015, mort2017)\ndim(dat.mortality)\n#> [1] 101316      8\n```\n:::\n\n\n\n**Examine Mortality Eligibility Status:**\n\nAfter combining the datasets, it's important to examine the `mort_eligstat` variable. This variable indicates the eligibility status of each participant for the mortality follow-up study. The codes are defined as follows:\n\n`1`: Eligible for mortality follow-up.\n\n`2`: Under age 18 and not available for public release.\n\n`3`: Ineligible for other reasons.\n\n`NA`: Missing eligibility status.\n\nThe `table()` function is used to see the distribution of participants across these categories.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/ELIGSTAT_f206cb41070892c7b68211a6abf11cf5'}\n\n```{.r .cell-code}\ntable(dat.mortality$mort_eligstat, useNA = \"always\")\n#> \n#>     1     2     3  <NA> \n#> 59064 42112   140     0\n```\n:::\n\n\n\n---\n\n* R Code Chunk 5: Final Merge of NHANES and Mortality Data\n\nThe following code performs the final merge, joining the combined NHANES dataset (`dat.full`) with the combined mortality dataset (`dat.mortality`). The two datasets are linked using the unique participant identifier, `id`. By setting the argument `all.x = TRUE`, all participants from the combined NHANES dataset are kept, regardless of whether they have a matching record in the combined mortality dataset.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/finalMerge_a99bdafee7f94974c9d478dbd46b0a0c'}\n\n```{.r .cell-code}\ndat.full.with.mortality <- merge(dat.full, dat.mortality, \n                                 by = \"id\", all.x = TRUE)\n\ndim(dat.full.with.mortality)\n#> [1] 101316     19\n```\n:::\n\n\n\n---\n\n* R Code Chunk 6: Save Final Dataset\n\nFinally, the complete, merged dataset is saved as an RDS file. This file, `dat.full.with.mortality.RDS`, will be the starting point for the statistical analysis in the next chapter.\n\n\n\n::: {.cell hash='03b-mortality-merge_cache/pdf/savefull_b5d18a9fdf6d12910e6bb5140700968a'}\n\n```{.r .cell-code}\nsaveRDS(dat.full.with.mortality, \n        file = \"data/dat.full.with.mortality.RDS\")\n```\n:::\n\n\n\nThis concludes the second part of the data preparation stage.\n\n---\n\n## Chapter Summary and Next Steps\n\nThis chapter concluded the data preparation phase. We first combined the 10 individual NHANES survey cycles into a single, comprehensive dataset and adjusted the survey weights for the pooled 20-year period.\n\nSubsequently, we acquired the public-use mortality follow-up data and merged it with the NHANES data by participant ID. The final output of this chapter is a single, complete dataset that links baseline survey data to long-term mortality outcomes, forming the foundation for all statistical analyses in the chapters that follow.\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}