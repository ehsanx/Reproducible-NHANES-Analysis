{
  "hash": "4dc61ea967612da8947b97015cdc8d00",
  "result": {
    "markdown": "# Variable Definitions and Cleaning\n\n---\n\nThis section continues the data preparation process using the combined NHANES and mortality dataset created in the previous section, `dat.full.with.mortality`. Here, we will construct the final variables required for our survival analysis. This includes defining the exposure, outcome, and follow-up time, as well as creating the final analytic dataset by applying inclusion criteria and handling missing data.\n\n\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/libraries_6659bd144db160df5b3a7d3268ce588b'}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(car)\n#> Loading required package: carData\nlibrary(DataExplorer)\n```\n:::\n\n\n\n---\n\n* R Code Chunk 1: Load Complete Merged Data\n\nThe following code begins by loading the `dat.full.with.mortality.RDS` file. This dataset is the complete, merged result from the previous chapter, containing the processed demographic, smoking, and mortality data for all participants. The `readRDS()` function loads the file from the `data/` directory, and the `colnames()` function is used to display the names of all its columns.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/readmerged_8987b7393cd1cb0b57732241dc5799b9'}\n\n```{.r .cell-code}\n# Load previous data file\ndat.full.with.mortality <- \n  readRDS(\"data/dat.full.with.mortality.RDS\")\n\ncolnames(dat.full.with.mortality)\n#>  [1] \"id\"                 \"age\"                \"sex\"               \n#>  [4] \"race\"               \"born\"               \"smoking.age\"       \n#>  [7] \"smoked.while.child\" \"smoking\"            \"psu\"               \n#> [10] \"strata\"             \"year\"               \"survey.weight.new\" \n#> [13] \"mort_eligstat\"      \"mort_stat\"          \"mort_ucod_leading\" \n#> [16] \"mort_diabetes\"      \"mort_hyperten\"      \"mort_permth_int\"   \n#> [19] \"mort_permth_exm\"\n```\n:::\n\n\n\n---\n\n## Creating Key Analysis Variables\n\n* R Code Chunk 2: Variable Construction\n\nThis section details the construction of the key variables essential for our survival analysis. This includes defining the exposure variable (age at smoking initiation), the survival outcome, and the follow-up time.\n\n**1. Exposure Variable: Age at Smoking Initiation Categories (exposure.cat)**\n\nThe following code creates the primary exposure variable for our analysis, `exposure.cat`. The numeric `smoking.age` variable (`SMD030` from NHANES) is categorized into six levels based on age ranges used in the original paper. This categorization is based on established age ranges for smoking initiation used in previous research, and aims to capture distinct developmental and addiction risk profiles. We first inspect the raw distribution of `smoking.age` before using `car::recode()` to create the new factor and explicitly setting the level order to ensure \"Never smoked\" is the reference category.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/var_construction_e2ec59aa6abb16d8801aaae45d33a4cb'}\n\n```{.r .cell-code}\n# Display initial distribution of raw smoking.age\ntable(dat.full.with.mortality$smoking.age, useNA = \"always\")\n#> \n#>     0     5     6     7     8     9    10    11    12    13    14    15    16 \n#> 31915     4     3   106   100   157   261   240   841  1207  1597  2354  2973 \n#>    17    18    19    20    21    22    23    24    25    26    27    28    29 \n#>  2399  3591  1510  1755   995   708   415   263   760   166   173   156    63 \n#>    30    31    32    33    34    35    36    37    38    39    40    41    42 \n#>   370    26    71    29    22   143    34    24    28    19    98     9    18 \n#>    43    44    45    46    47    48    49    50    51    52    53    54    55 \n#>    14    11    44    11     7     6     5    25     4     2     1     4     8 \n#>    56    57    58    59    60    62    63    64    65    68    70    71    72 \n#>     2     1     5     2     2     2     1     1     4     4     1     1     4 \n#>    74    76    77  <NA> \n#>     2     1     1 45537\n\n# Recode smoking.age into categorical exposure.cat\ndat.full.with.mortality$exposure.cat <- car::recode(\ndat.full.with.mortality$smoking.age, \"\n0 = 'Never smoked'; 1:9 = 'Started before 10'; \n10:14 = 'Started at 10-14'; 15:17 = 'Started at 15-17'; \n18:20 = 'Started at 18-20'; 21:80 = 'Started after 20'; \nelse = NA \", as.factor = TRUE)\n\n# Explicitly set the order of factor levels\ndat.full.with.mortality$exposure.cat <- \n  factor(dat.full.with.mortality$exposure.cat,\n         levels = c(\"Never smoked\", 'Started before 10',\n                    'Started at 10-14', \"Started at 15-17\",\n                    \"Started at 18-20\", \"Started after 20\"))\n```\n:::\n\n\n\nThe following tables are used to inspect the distribution of the newly created exposure variable, both overall and broken down by mortality status.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/tables_1cad102a66dc8049c44b99dc1f894d81'}\n\n```{.r .cell-code}\n# Display distributions of the newly created exposure variable\ntable(dat.full.with.mortality$exposure.cat, useNA = \"always\")\n#> \n#>      Never smoked Started before 10  Started at 10-14  Started at 15-17 \n#>             31915               370              4146              7726 \n#>  Started at 18-20  Started after 20              <NA> \n#>              6856              4766             45537\n\n\n# Display distributions of exposure.cat level\n# broken down by mort_stat variable\ntable(dat.full.with.mortality$exposure.cat,\n      dat.full.with.mortality$mort_stat, useNA = \"always\")\n#>                    \n#>                         0     1  <NA>\n#>   Never smoked      27823  3994    98\n#>   Started before 10   254   116     0\n#>   Started at 10-14   3217   922     7\n#>   Started at 15-17   6193  1522    11\n#>   Started at 18-20   5438  1405    13\n#>   Started after 20   3618  1140     8\n#>   <NA>               3272   150 42115\n```\n:::\n\n\n\n**2. Outcome and Follow-up Time Variables**\n\nThe following code constructs the variables for the survival analysis. As noted in the original paper, the time of birth is designated as the baseline to prevent differential start times for exposed and unexposed participants. The primary survival outcome is therefore the time from birth to all-cause mortality. Specifically, this is calculated by combining the participant's age at the interview (from the RIDAGEYR variable) with their mortality follow-up time from the interview date (from the PERMTH_INT variable). We also define the `status_all` variable from the raw mortality data to indicate the participant's final mortality status.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/survivalVar_4b1ea0aacac7f1884f88e8291abeb7dc'}\n\n```{.r .cell-code}\n# Survival time Person-Months of Follow-up from Interview date\n# (PERMTH_INT)\ndat.full.with.mortality$stime.since.interview <- \n  dat.full.with.mortality$mort_permth_int \nsummary(dat.full.with.mortality$stime.since.interview) \n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's \n#>     0.0    59.0   113.0   117.9   172.0   250.0   42252\n\n\n# Age in month at NHANES interview \n# (RIDAGEYR)\ndat.full.with.mortality$age.month <- dat.full.with.mortality$age * 12\nsummary(dat.full.with.mortality$age.month)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n#>     0.0   120.0   288.0   373.5   624.0  1020.0\n\n\n# Survival time - Person-Months of Follow-up from birth = age at \n# screening (months) + person-months of follow-up from interview.\n# This combines the age at interview with the time from interview \n# to death or end of follow-up.\ndat.full.with.mortality$stime.since.birth <- \n  with(dat.full.with.mortality, age.month + stime.since.interview)\n\n\n# Convert to years for consistent interpretation with age\ndat.full.with.mortality$stime.since.birth <- dat.full.with.mortality$stime.since.birth/12\n\n\n# Ensure NA values are consistent if stime.since.interview was NA\ndat.full.with.mortality$stime.since.birth[\n  is.na(dat.full.with.mortality$stime.since.interview)] <- NA\nsummary(dat.full.with.mortality$stime.since.birth)\n#>    Min. 1st Qu.  Median    Mean 3rd Qu.    Max.    NA's \n#>   19.08   41.50   57.17   57.56   72.92  105.67   42252\n\n\n# All-cause mortality status (PRIMARY outcome)\ndat.full.with.mortality$status_all <- \n  dat.full.with.mortality$mort_stat\ntable(dat.full.with.mortality$status_all, useNA = \"always\")\n#> \n#>     0     1  <NA> \n#> 49815  9249 42252\n```\n:::\n\n\n\n**3. Final Variable Cleaning**\n\nThe following code drops mortality-related variables not needed for the final analytic dataset.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/dropVar_0e794a59123256d200516262d769209b'}\n\n```{.r .cell-code}\n# Remove unneeded columns\ndat.full.with.mortality$mort_diabetes <- NULL\ndat.full.with.mortality$mort_hyperten <- NULL\ndat.full.with.mortality$mort_permth_int <- NULL\ndat.full.with.mortality$mort_permth_exm <- NULL\ndat.full.with.mortality$mort_ucod_leading <- NULL\ndat.full.with.mortality$mort_eligstat <- NULL\n```\n:::\n\n\n\n**4. Recoding Survey Year: year.cat**\n\nThe `year` variable, representing the NHANES survey cycle is recoded into a more descriptive categorical variable, `year.cat`.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/recoding_year_b35b4c1db7c3e6eb5e5f18b27592a2c2'}\n\n```{.r .cell-code}\n# Recode year variable into a factor with descriptive labels\ndat.full.with.mortality$year.cat <- dat.full.with.mortality$year\n\nnew_levels <- c(\n  \"1999-2000\", \"2001-2002\", \"2003-2004\", \n  \"2005-2006\", \"2007-2008\", \"2009-2010\",\n  \"2011-2012\", \"2013-2014\", \"2015-2016\",\n  \"2017-2018\"\n)\n\nlevels(dat.full.with.mortality$year.cat) <- new_levels\n\n# Display the unique levels of the new year.cat variable\nlevels(dat.full.with.mortality$year.cat)\n#>  [1] \"1999-2000\" \"2001-2002\" \"2003-2004\" \"2005-2006\" \"2007-2008\" \"2009-2010\"\n#>  [7] \"2011-2012\" \"2013-2014\" \"2015-2016\" \"2017-2018\"\n```\n:::\n\n\n\n---\n\n## Constructing the Final Analytic Cohort\n\n* R Code Chunk 3: Final Analytic Dataset Construction\n\nThe following code creates the final analytic dataset by applying the specific inclusion and exclusion criteria used in the published paper. The two main steps are restricting the participant age range to 20–79 years and performing a complete-case analysis by excluding observations with missing data for key variables.\n\n**1. Apply Age and Variable Exclusions**\n\nFirst, we apply the age restriction, keeping only participants between 20 and 79 years old. We also drop several intermediate or raw variables that are no longer needed for the final analysis. We will remove the `smoked.while.child` variable. While this variable was created as a simple binary indicator for early smoking, the final analysis relies on the more granular, multi-level `exposure.cat` variable.\n\n::: {.callout-note}\nThe `exposure.cat` variable (e.g., 'Started before 10', 'Started at 10-14') is superior for our research question because it allows us to investigate a dose-response relationship—that is, to see if the risk of mortality changes incrementally with different ages of initiation. A simple binary variable like `smoked.while.child` would only allow us to compare \"early starters\" to everyone else, masking the important nuances in risk across different age groups. Therefore, it is excluded from the final analytic dataset.\n:::\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/age_ec429ef6aca69da7e0eb29cfd21da329'}\n\n```{.r .cell-code}\n# Drop the following column not being used\ndat.full.with.mortality$smoked.while.child <- NULL \n\n### Analytic Dataset - age 20 - 79\n\n# Inclusion criteria: adults aged between 20 and 79 years\ndat.analytic <- subset(dat.full.with.mortality, age>=20 & age < 80)\n\n# Dimensions before age filtering\ndim(dat.full.with.mortality)\n#> [1] 101316     18\n\n# Dimensions after age filtering\ndim(dat.analytic)\n#> [1] 50824    18\n\n# Calculate number of participants dropped due to age restriction\ndim(dat.full.with.mortality)[1] - dim(dat.analytic)[1]\n#> [1] 50492\n```\n:::\n\n\n\nDrop other variables that are not being used in the final analysis.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/drop_d4a47628059a79467b59043e766ff9a4'}\n\n```{.r .cell-code}\ndat.analytic$born <- NULL\ndat.analytic$age <- NULL\ndat.analytic$age.month <- NULL\n\n# Dimension\ndim(dat.analytic) \n#> [1] 50824    15\n```\n:::\n\n\n\n**2. Apply Complete-Case Analysis**\n\nNext, we exclude participants who have missing data for the primary outcome (survival time) or the primary exposure (smoking initiation category). This is consistent with the original paper, which notes that about 0.5% of the sample (275 observations) was discarded for this reason. Also, there were no missing values in the covariates variables considered in the main analysis.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/exposure/outcome_92d9714846ef7c22c1de8eb50e121ba4'}\n\n```{.r .cell-code}\n# Participants with incomplete data on smoking status \n# or mortality were excluded\ndat.analytic1 <- dat.analytic[\n  complete.cases(dat.analytic$stime.since.birth),]\ndim(dat.analytic1) # Dimension after removing missing survival time\n#> [1] 50690    15\n\ndat.analytic2 <- dat.analytic1[\n  complete.cases(dat.analytic1$exposure.cat),]\ndim(dat.analytic2) # Dimension after removing missing exposure var\n#> [1] 50549    15\n\n# Complete case analysis: remove missing values in covariates\ndat.complete <- na.omit(dat.analytic2) # No missing values\ndim(dat.complete)\n#> [1] 50549    15\n```\n:::\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/profile-missing_b8a337d400d23dfc2cde41368c5f3fd8'}\n\n```{.r .cell-code}\n# Profile missingness after initial filtering\nprofile_missing(dat.analytic2)\n#>                  feature num_missing pct_missing\n#> 1                     id           0           0\n#> 2                    sex           0           0\n#> 3                   race           0           0\n#> 4            smoking.age           0           0\n#> 5                smoking           0           0\n#> 6                    psu           0           0\n#> 7                 strata           0           0\n#> 8                   year           0           0\n#> 9      survey.weight.new           0           0\n#> 10             mort_stat           0           0\n#> 11          exposure.cat           0           0\n#> 12 stime.since.interview           0           0\n#> 13     stime.since.birth           0           0\n#> 14            status_all           0           0\n#> 15              year.cat           0           0\n```\n:::\n\n\n\n**3. Reconcile Sample Sizes** The following code calculates the number of participants dropped at each stage of the filtering process. This helps confirm that our data cleaning has resulted in the same final sample size as the original study.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/num_dropped_36406ecc46ba34f573163f128193c23c'}\n\n```{.r .cell-code}\n# Participants dropped - overall\nnrow(dat.full.with.mortality) - nrow(dat.complete)\n#> [1] 50767\n\n# Participants dropped - due to missing exposure or outcome\nnrow(dat.analytic) - nrow(dat.analytic2)\n#> [1] 275\n\n# Participants dropped - due to missing covariates\nnrow(dat.analytic2) - nrow(dat.complete)\n#> [1] 0\n```\n:::\n\n\n\n---\n\n## Exporting Final Datasets\n\n* R Code Chunk 4: Save Final Datasets\n\nThe final step is to save our processed datasets. We save three different versions of the data to create useful checkpoints for the analysis:\n\n-   `dat.full.with.mortality.RData`: The updated, merged dataset before any filtering was applied in this chapter.\n-   `dat.analytic2.RData`: The dataset after applying age restrictions and removing participants with missing outcome or exposure data.\n-   `dat.complete.RData`: The final, clean analytic dataset containing only complete cases.\n\n\n\n::: {.cell hash='04-variable-cleaning_cache/pdf/save_dcb4a6d9fa3522a78cc35736d01e499b'}\n\n```{.r .cell-code}\n# Save\nsave(dat.full.with.mortality, \n     file = \"data/dat.full.with.mortality.RData\")\n\nsave(dat.analytic2, \n     file = \"data/dat.analytic2.RData\")\n\nsave(dat.complete, \n     file = \"data/dat.complete.RData\")\n```\n:::\n\n\n\nThis completes the variable definitions and cleaning part of the data preparation stage.\n\n## Chapter Summary and Next Steps\n\nIn this chapter, we constructed the core variables for the analysis, including the categorized smoking initiation exposure (`exposure.cat`) and the survival outcome (time from birth to all-cause mortality). We then applied the study's inclusion and exclusion criteria to create the final, complete-case analytic dataset with 50,549 participants, matching the sample size of the original paper.\n\nWith a clean dataset ready, the next chapter, \"Cohort Definition,\" will formally summarize the criteria used to define our study population.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}