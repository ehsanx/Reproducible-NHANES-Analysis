{
  "hash": "7c165b8f55ec27ab6d6cfc2d6f5e78ed",
  "result": {
    "markdown": "# Survival Analysis\n\n---\n\nThis section performs the main survival analyses to investigate the association between early smoking initiation and all-cause mortality. We will first visualize survival probabilities using Kaplan-Meier curves and then estimate hazard ratios (HRs) with survey-weighted Cox Proportional Hazards models. This section directly reproduces the \"Statistical Analysis\" and \"Results\" sections of the published paper. Specifically, Figure 1 (Kaplan-Meier curve) and Figure 2 (the crude/adjusted HRs) of the original paper.\n\nThis chapter will reproduce the paper's core survival analyses using the following methods:\n\n| Analysis/Visualization | Key R Function(s) | Purpose | Reproduces |\n| :--- | :--- | :--- | :--- |\n| **Kaplan-Meier Curve** | `svykm()`, `svylogrank()` | Visualize and test differences in survival probabilities between exposure groups. | **Figure 1** |\n| **Crude Cox Model** | `svycoxph()` | Estimate the unadjusted association between smoking initiation and mortality. | **Figure 2** (Crude HRs) |\n| **Adjusted Cox Model** | `svycoxph()` | Estimate the association while controlling for confounders (sex, race, survey year). | **Figure 2** (Adjusted HRs) |\n\n\n\n\n\n::: {.cell hash='08-survival-analysis_cache/html/libraries_e01315c5e7762df314c4c11e7deebf19'}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(Publish) \nlibrary(survey) \noptions(survey.want.obsolete=TRUE)\nlibrary(survival)\nrequire(knitr)\nrequire(kableExtra)\nrequire(stringr)\n```\n:::\n\n\n---\n\n* R Code Chunk 1: Load Data and Survey Design Object\n\nWe begin by loading the final, complete-case analytic dataset (`dat.complete`) and the survey design object (`w.design0`) that were created in the previous chapters. The `w.design0` object is essential for ensuring our analysis accounts for the complex NHANES survey design.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/load_1cad5540102e478cc074a2ee532be192'}\n\n```{.r .cell-code}\n# Load the complete case analytic dataset\nload(file = \"data/dat.complete.RData\")\n\n# Load the subsetted survey design object\nw.design0 <- readRDS(file = \"data/w.design0.rds\")\n\n# Verify the dimensions of the loaded survey design object\ndim(w.design0)\n#> [1] 50549    19\n```\n:::\n\n\n---\n\n## Kaplan-Meier Survival Analysis (Figure 1)\n\n* R Code Chunk 2: Kaplan-Meier Curves and Log-Rank Test\n\n**Kaplan-Meier Curves**\n\nThe following code visualizes the survival probabilities over time using Kaplan-Meier (KM) curves, stratified by the `exposure.cat` (age at smoking initiation) variable. The KM curves illustrate the proportion of participants surviving over their follow-up time from birth. The `svykm()` function from the `survey` package is used to calculate the survival estimates while accounting for the complex survey design. The resulting plot reproduces the trends shown in Figure 1 of the original paper.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/KM_a53cec8b0c8cf951393bbc144a343c75'}\n\n```{.r .cell-code}\n\n# Define the survival formula\nformulax0 <- as.formula(Surv(stime.since.birth, status_all) \n                        ~ exposure.cat)\n\n# Calculate survey-weighted Kaplan-Meier curves\nsA <- svykm(formulax0, design = w.design0)\nsaveRDS(sA, file = \"data/sA.rds\")\n\n# Dynamically set the number of colors for the legend\ndummy <- length(unique(as.factor(w.design0$variables$exposure.cat)))\n\n# Plot the Kaplan-Meier curves\nplot(sA, pars = list(col = c(1:dummy)),\n     xlab = \"Time\",\n     ylab = \"Proportion surviving\",\n     main = \"Survey-featured Kaplan-Meier Curve:\n     All-Cause Mortality\")\nlegend(\"bottomleft\", \n       levels(as.factor(w.design0$variables$exposure.cat)),\n       col = (1:dummy), lty = c(1,1),\n       bty = \"n\")\n```\n\n::: {.cell-output-display}\n![Survey-weighted Kaplan-Meier curves for all-cause mortality, stratified by age of smoking initiation (reproduces Figure 1 from the paper).](08-survival-analysis_files/figure-html/KM-1.png){width=672}\n:::\n:::\n\n\n**Log-Rank Test**\n\nAfter plotting the curves, a survey-weighted log-rank test is performed using `svylogrank()` to statistically determine if there are significant differences in survival curves among the exposure groups. A significant p-value from this test would indicate a statistically significant difference in survival experiences between the age groups of smoking initiation. The paper states that the log-rank test was significant.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/log-rank_94a3a8c60c974bd9d015d5b71186f52b'}\n\n```{.r .cell-code}\n# Perform the survey-weighted log-rank test\nlrt <- svylogrank(formulax0, design = subset(w.design0, \n                                             survey.weight.new > 0))\n\n# Display the rounded p-value from the log-rank test\nround(lrt[[2]],2)\n#>  Chisq      p \n#> 293.72   0.00\n```\n:::\n\n\nTo present these results more formally, the following code uses `knitr::kable()` to display the full test output, including the Chi-squared statistic and degrees of freedom, in a clean table.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/logrank-Results_e8420ac0ba42f667525cb4495fa3396b'}\n\n```{.r .cell-code}\nkable(lrt[[1]],\n      booktabs = TRUE, digits = 2,\n      col.names = c(\"Test Statistic\", \"Standard Error\", \"Z-value\", \"p-value\"),\n      caption=\"Survey-weighted log-rank test for main analysis comparing survival distributions by age of smoking initiation.\") %>%\n  kable_styling(latex_options = \"hold_position\")\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"margin-left: auto; margin-right: auto;\">\n<caption>Survey-weighted log-rank test for main analysis comparing survival distributions by age of smoking initiation.</caption>\n <thead>\n  <tr>\n   <th style=\"text-align:right;\"> Test Statistic </th>\n   <th style=\"text-align:right;\"> Standard Error </th>\n   <th style=\"text-align:right;\"> Z-value </th>\n   <th style=\"text-align:right;\"> p-value </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:right;\"> 146771.4 </td>\n   <td style=\"text-align:right;\"> 33970.03 </td>\n   <td style=\"text-align:right;\"> 4.32 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1057040.8 </td>\n   <td style=\"text-align:right;\"> 110866.82 </td>\n   <td style=\"text-align:right;\"> 9.53 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 1215922.9 </td>\n   <td style=\"text-align:right;\"> 137852.17 </td>\n   <td style=\"text-align:right;\"> 8.82 </td>\n   <td style=\"text-align:right;\"> 0.00 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 259155.7 </td>\n   <td style=\"text-align:right;\"> 128215.04 </td>\n   <td style=\"text-align:right;\"> 2.02 </td>\n   <td style=\"text-align:right;\"> 0.04 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:right;\"> 235676.6 </td>\n   <td style=\"text-align:right;\"> 91478.11 </td>\n   <td style=\"text-align:right;\"> 2.58 </td>\n   <td style=\"text-align:right;\"> 0.01 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::\n\n\n---\n\n## Cox Proportional Hazards Models (Figure 2)\n\n### Unadjusted Model (Crude HRs)\n\n* R Code Chunk 3: Unadjusted Cox Model (for Comparison)\n\nThe following code demonstrates a standard, un-weighted Cox proportional hazards model using base R's `coxph()` function on the `dat.complete` dataset. This model does not account for the complex survey design of NHANES and is included as a baseline, primarily for comparison or to understand how unweighted models would be run. The `publish()` function is used to format the model output for easier interpretation.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/unadjustedModel_9e25aa0f240b9eebc1461182f12cf881'}\n\n```{.r .cell-code}\n# Fit an un-weighted Cox Proportional Hazards model\nfit0 <- coxph(Surv(stime.since.birth, status_all) ~ exposure.cat, \n              data = dat.complete)\n\n# Use 'publish' to format the output for display\npublish(fit0)\n#>      Variable             Units HazardRatio       CI.95 p-value \n#>  exposure.cat      Never smoked         Ref                     \n#>               Started before 10        2.44 [1.99;3.00]  <0.001 \n#>                Started at 10-14        2.37 [2.19;2.58]  <0.001 \n#>                Started at 15-17        1.92 [1.79;2.06]  <0.001 \n#>                Started at 18-20        1.51 [1.40;1.62]  <0.001 \n#>                Started after 20        1.51 [1.39;1.64]  <0.001\n```\n:::\n\n\n---\n\n* R Code Chunk 4: Unadjusted Survey-Weighted Cox Proportional Hazards Model\n\nThe following code fits the unadjusted Cox proportional hazards model, but it uses `svycoxph()` from the `survey` package to account for the complex NHANES survey design. This model examines the crude association between smoking initiation categories and all-cause mortality, producing Hazard Ratios. The `publish()` function is used to format the model output for easier interpretation. The HRs from this model contribute to the \"Crude\" estimates shown in Figure 2 of the paper.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/unadjusted-survey_0ec3cac7ce011e55ced325569e160874'}\n\n```{.r .cell-code}\n# Fit the unadjusted survey-weighted Cox Proportional Hazards model\nfit0 <- svycoxph(Surv(stime.since.birth, status_all) ~ exposure.cat, \n                 design = w.design0)\n\n# Use 'publish' to format the output for display\nf0 <- publish(fit0) \n#> Stratified 1 - level Cluster Sampling design (with replacement)\n#> With (301) clusters.\n#> subset(w.design, miss == 0 & survey.weight.new > 0)\n#>      Variable             Units HazardRatio       CI.95 p-value \n#>  exposure.cat      Never smoked         Ref                     \n#>               Started before 10        3.01 [2.29;3.95]  <0.001 \n#>                Started at 10-14        2.60 [2.32;2.92]  <0.001 \n#>                Started at 15-17        2.07 [1.88;2.28]  <0.001 \n#>                Started at 18-20        1.55 [1.40;1.72]  <0.001 \n#>                Started after 20        1.60 [1.45;1.76]  <0.001\n```\n:::\n\n\n---\n\n* R Code Chunk 5: Process Unadjusted Hazard Ratios for Plotting\n\nThe output from `publish()` is a formatted table, but for plotting, we need a clean data frame of the results.\n\nThe following code extracts the Hazard Ratios and their 95% Confidence Intervals from the unadjusted survey-weighted Cox Model (`f0`). The `stringr` package is used to parse the confidence interval strings into separate lower and upper bound numeric columns.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/unadjustedHRs_754f80a06f8b13d55b87819d799611f5'}\n\n```{.r .cell-code}\n# Select HR and CI columns for exposure categories from 'f0'\nf0r <- f0$regressionTable[2:6,c(\"HazardRatio\",\"CI.95\")] \n\n# Add a 'group' column to label these results as \"Crude\" for plotting\nf0r$group <- \"Crude\"\n\n# Extract lower and upper bounds from the CI string\nci <- str_extract_all(f0r[,2], '\\\\d+([.,]\\\\d+)?', simplify = TRUE)\nf0r$CI.l <- as.numeric(as.character(ci[,1])) # Lower bound\nf0r$CI.u <- as.numeric(as.character(ci[,2])) # Upper bound\n\n# Rename columns for consistency in plotting\nnames(f0r) <- c(\"mean\",\"CI.95\",\"group\",\"lower\",\"upper\")\n\n# Display the processed data frame\nf0r\n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"mean\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"CI.95\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"group\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"lower\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"upper\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"3.01\",\"2\":\"[2.29;3.95]\",\"3\":\"Crude\",\"4\":\"2.29\",\"5\":\"3.95\",\"_rn_\":\"2\"},{\"1\":\"2.60\",\"2\":\"[2.32;2.92]\",\"3\":\"Crude\",\"4\":\"2.32\",\"5\":\"2.92\",\"_rn_\":\"3\"},{\"1\":\"2.07\",\"2\":\"[1.88;2.28]\",\"3\":\"Crude\",\"4\":\"1.88\",\"5\":\"2.28\",\"_rn_\":\"4\"},{\"1\":\"1.55\",\"2\":\"[1.40;1.72]\",\"3\":\"Crude\",\"4\":\"1.40\",\"5\":\"1.72\",\"_rn_\":\"5\"},{\"1\":\"1.60\",\"2\":\"[1.45;1.76]\",\"3\":\"Crude\",\"4\":\"1.45\",\"5\":\"1.76\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n---\n\n### Adjusted Model (Adjusted HRs)\n\n* R Code Chunk 6: Adjusted Survey-Weighted Cox Proportional Hazards Model\n\nThe following code fits the adjusted Cox proportional hazards model, accounting for the complex survey design and controlling for **key covariates**. As described in the paper, the model is adjusted to account for **sex, race/ethnicity, and survey cycle**. This model estimates the adjusted Hazard Ratios, which contribute to the \"Adjusted\" estimates shown in Figure 2 of the paper.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/adjusted-survey_de148355354c72dcb08d6a87de765518'}\n\n```{.r .cell-code}\n# Fit the adjusted survey-weighted Cox Proportional Hazards model\nfit1 <- svycoxph(Surv(stime.since.birth, status_all) ~ exposure.cat + \n                   sex + race + year.cat, design = w.design0)\n\n# Use 'publish' to format the output for display\nf1 <- publish(fit1) # Store the published output\n#> Stratified 1 - level Cluster Sampling design (with replacement)\n#> With (301) clusters.\n#> subset(w.design, miss == 0 & survey.weight.new > 0)\n#>      Variable             Units HazardRatio       CI.95   p-value \n#>  exposure.cat      Never smoked         Ref                       \n#>               Started before 10        2.71 [2.05;3.58]   < 0.001 \n#>                Started at 10-14        2.38 [2.11;2.68]   < 0.001 \n#>                Started at 15-17        1.96 [1.77;2.16]   < 0.001 \n#>                Started at 18-20        1.48 [1.33;1.64]   < 0.001 \n#>                Started after 20        1.54 [1.39;1.70]   < 0.001 \n#>           sex              Male         Ref                       \n#>                          Female        0.75 [0.70;0.80]   < 0.001 \n#>          race             White         Ref                       \n#>                           Black        1.59 [1.47;1.73]   < 0.001 \n#>                        Hispanic        1.03 [0.93;1.15]   0.55581 \n#>                          Others        1.15 [0.97;1.37]   0.10079 \n#>      year.cat         1999-2000         Ref                       \n#>                       2001-2002        0.96 [0.86;1.08]   0.50457 \n#>                       2003-2004        0.84 [0.75;0.94]   0.00328 \n#>                       2005-2006        0.76 [0.67;0.85]   < 0.001 \n#>                       2007-2008        0.77 [0.67;0.90]   < 0.001 \n#>                       2009-2010        0.68 [0.59;0.78]   < 0.001 \n#>                       2011-2012        0.62 [0.51;0.76]   < 0.001 \n#>                       2013-2014        0.58 [0.48;0.69]   < 0.001 \n#>                       2015-2016        0.35 [0.27;0.45]   < 0.001 \n#>                       2017-2018        0.20 [0.13;0.29]   < 0.001\n```\n:::\n\n\n---\n\n* R Code Chunk 7: Process Adjusted Hazard Ratios for Plotting\n\nThe following code follows the similar processing done for the unadjusted model, but applies it to the results of the adjusted survey-weighted Cox model.\n\n\n::: {.cell hash='08-survival-analysis_cache/html/adjustedHRs_68fde33c8e45ead0fde89d89c29120dc'}\n\n```{.r .cell-code}\n# Select Hazard Ratio and CI columns for exposure categories from 'f1'\nf1r <- f1$regressionTable[2:6,c(\"HazardRatio\",\"CI.95\")]\n\n# Add a 'group' column to label these results as \"Adjusted\"\nf1r$group <- \"Adjusted\"\n\n# Extract lower and upper bounds from the CI string\nci <- str_extract_all(f1r[,2], '\\\\d+([.,]\\\\d+)?', simplify = TRUE)\nf1r$CI.l <- as.numeric(as.character(ci[,1]))\nf1r$CI.u <- as.numeric(as.character(ci[,2]))\n\n# Rename columns for consistency in plotting\nnames(f1r) <- c(\"mean\",\"CI.95\",\"group\",\"lower\",\"upper\")\n\n# Display the processed data frame\nf1r \n```\n\n::: {.cell-output-display}\n`````{=html}\n<div data-pagedtable=\"false\">\n  <script data-pagedtable-source type=\"application/json\">\n{\"columns\":[{\"label\":[\"\"],\"name\":[\"_rn_\"],\"type\":[\"\"],\"align\":[\"left\"]},{\"label\":[\"mean\"],\"name\":[1],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"CI.95\"],\"name\":[2],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"group\"],\"name\":[3],\"type\":[\"chr\"],\"align\":[\"left\"]},{\"label\":[\"lower\"],\"name\":[4],\"type\":[\"dbl\"],\"align\":[\"right\"]},{\"label\":[\"upper\"],\"name\":[5],\"type\":[\"dbl\"],\"align\":[\"right\"]}],\"data\":[{\"1\":\"2.71\",\"2\":\"[2.05;3.58]\",\"3\":\"Adjusted\",\"4\":\"2.05\",\"5\":\"3.58\",\"_rn_\":\"2\"},{\"1\":\"2.38\",\"2\":\"[2.11;2.68]\",\"3\":\"Adjusted\",\"4\":\"2.11\",\"5\":\"2.68\",\"_rn_\":\"3\"},{\"1\":\"1.96\",\"2\":\"[1.77;2.16]\",\"3\":\"Adjusted\",\"4\":\"1.77\",\"5\":\"2.16\",\"_rn_\":\"4\"},{\"1\":\"1.48\",\"2\":\"[1.33;1.64]\",\"3\":\"Adjusted\",\"4\":\"1.33\",\"5\":\"1.64\",\"_rn_\":\"5\"},{\"1\":\"1.54\",\"2\":\"[1.39;1.70]\",\"3\":\"Adjusted\",\"4\":\"1.39\",\"5\":\"1.70\",\"_rn_\":\"6\"}],\"options\":{\"columns\":{\"min\":{},\"max\":[10]},\"rows\":{\"min\":[10],\"max\":[10]},\"pages\":{}}}\n  </script>\n</div>\n`````\n:::\n:::\n\n\n---\n\n## Saving Model Results\n\n* R Code Chunk 8: Save Processed Results\n\nFinally, we save the two processed data frames (`f0r` and `f1r`) containing the crude and adjusted results. These files will be loaded in the next section to create the plot that visualizes these findings (Figure 2 of paper).\n\n\n::: {.cell hash='08-survival-analysis_cache/html/save-df_c91d171bd3460290c7398e7f785b490e'}\n\n```{.r .cell-code}\n# Save the processed HR data frames for the next chapter\nsaveRDS(f0r, file = \"data/f0r.rds\")\nsaveRDS(f1r, file = \"data/f1r.rds\")\n```\n:::\n\n\nThis completes the survival analysis section of the statistical analysis stage.\n\n---\n\n## Chapter Summary and Next Steps\n\nWe have now completed the main survival analysis. We successfully reproduced the Kaplan-Meier curves (Figure 1 from the paper) to visualize survival probabilities and fitted both crude and adjusted survey-weighted Cox models to estimate the hazard ratios, replicating the core findings presented in Figure 2.\n\nThe results show a clear association between early smoking initiation and mortality. The next logical step, covered in the \"Effect Modification Analysis\" chapter, is to investigate whether this association differs across key demographic groups.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"site_libs/kePrint-0.0.1/kePrint.js\"></script>\n<link href=\"site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\n<link href=\"site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\n<script src=\"site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}