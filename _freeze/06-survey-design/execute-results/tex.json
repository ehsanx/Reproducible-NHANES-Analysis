{
  "hash": "b870152d4d9323b1d4b4599b6bc8cba8",
  "result": {
    "markdown": "# Survey Design Specification\n\n---\n\nThis section begins the statistical portion of the analysis by specifying the complex survey design of the NHANES data. In the previous chapters, the raw NHANES and mortality data were downloaded, cleaned, and merged, resulting in the `dat.full.with.mortality` and `dat.complete` datasets. Now, we will use the survey package in R to correctly account for the complex sampling design, which is a critical step for all subsequent analyses.\n\n\n\n\n\n::: {.cell hash='06-survey-design_cache/pdf/libraries_7e93d76f47d1d4da02d5172b79731747'}\n\n```{.r .cell-code}\n# Load required packages\nlibrary(survey) \noptions(survey.want.obsolete=TRUE)\n```\n:::\n\n\n\n## Loading the Analytic Datasets\n\n* R Code Chunk 1: Load Data\n\nThe following code loads the datasets created in the previous steps. `dat.full.with.mortality` contains the complete merged data, while `dat.complete` and `dat.analytic2` contain the filtered subsets that will be used to define the analytic sub-cohort for the survey design.\n\n\n\n::: {.cell hash='06-survey-design_cache/pdf/load_40ea03900cb0aa545a1b0cc58e11570b'}\n\n```{.r .cell-code}\n# Load the full merged dataset\nload(file = \"data/dat.full.with.mortality.RData\")\n\n# Load the intermediate analytic dataset \n# Used for subsetting the design\nload(file = \"data/dat.analytic2.RData\") \nload(file = \"data/dat.complete.RData\") \n\n# Check dimensions\ndim(dat.full.with.mortality)\n#> [1] 101316     18\ndim(dat.analytic2)\n#> [1] 50549    15\ndim(dat.complete)\n#> [1] 50549    15\n```\n:::\n\n\n\n**Note**: The `dat.complete` and `dat.analytic2` datasets are identical. This confirms that after participants with missing exposure or outcome data were removed, no missing values remained for the covariates used in the main analysis, as stated in the original paper\n\n---\n\n## Specifying the Survey Design\n\n* R Code Chunk 2: Specify the Survey Design Object\n\nTo correctly analyze NHANES data, we must account for its complex sampling design, which includes stratification, clustering, and unequal weighting. The following code uses the `survey` package to create a survey design object. This step is critical for obtaining accurate standard errors and p-values in all subsequent analyses.\n\n::: {.callout-note}\nAccounting for the complex sampling design is not just a formality; it is the most critical step for ensuring our results are statistically valid.\n\nWe will use the `svydesign()` function from the survey package to create a \"survey design object.\" This object bundles our dataset with the information on how the data was collected (the weights, strata, and PSUs). All of our subsequent analyses will be performed on this object, not on the raw data frame.\n\nFailing to perform this step and instead running analyses on the raw data would lead to severely underestimated standard errors and incorrect p-values, likely resulting in false positive findings. By specifying the design, we ensure our results are nationally representative and that our statistical inferences are trustworthy.\n:::\n\n\n**1. The `svydesign` Function**\n\nWe use the `svydesign()` function to combine the dataset with its design information. The key arguments are:\n\n-   `ids = ~psu`: Specifies the primary sampling unit (PSU) variable.\n-   `strata = ~strata`: Specifies the stratification variable.\n-   `weights = ~survey.weight.new`: Specifies the adjusted survey weight variable.\n-   `nest = TRUE`: Correctly handles PSUs that are nested within strata.\n\n**2. Subsetting the Design Object**\n\nFor correct variance estimation, the `survey` package requires us to define the design on the full dataset first and then specify the subset to be analyzed. We do this by creating a `miss` variable on the `dat.full.with.mortality` dataset. We then create the full design object (`w.design`) and use the `subset()` function to create the final analytic design object (`w.design0`). This final object includes only our cohort of interest (where `miss == 0`) and participants with positive survey weights.\n\n\n\n::: {.cell hash='06-survey-design_cache/pdf/survey_b5b4048c71ff9cdfa2ab51e526a23402'}\n\n```{.r .cell-code}\n# Set up the 'miss' indicator for subsetting the design\n# Initialize 'miss' as 1 (excluded) for all \n# in dat.full.with.mortality\ndat.full.with.mortality$miss <- 1\n\n# Set 'miss' to 0 (included) for participants whose 'id' \n# is in dat.analytic2\ndat.full.with.mortality$miss[dat.full.with.mortality$id \n                             %in% dat.analytic2$id] <- 0\n\n# Display the distribution of the 'miss' variable\ntable(dat.full.with.mortality$miss)\n#> \n#>     0     1 \n#> 50549 50767\n\n# Create the full survey design object\nw.design <- svydesign(ids = ~psu,\n                      strata = ~strata,\n                      weights = ~survey.weight.new,\n                      data = dat.full.with.mortality,\n                      nest = TRUE)\n\n# Subset the design to the analytic cohort (miss == 0) and \n# positive weights\nw.design0 <- subset(w.design, miss == 0 & survey.weight.new > 0)\n\n# Verify the number of observations in the subsetted design\ncat(\"Number of observations in w.design0 (subsetted design):\", \n    nrow(w.design0), \"\\n\")\n#> Number of observations in w.design0 (subsetted design): 50549\n```\n:::\n\n\n\n---\n\n## Saving the Survey Design Object\n\n* R Code Chunk 3: Save Survey Design Object\n\nFinally, we save the completed survey design object (`w.design0`) as an `.rds` file. This allows us to load this object directly in the next chapters without needing to re-run the design specification code, making our workflow more efficient.\n\n\n\n::: {.cell hash='06-survey-design_cache/pdf/save_c5750d929422b245546762392042acf9'}\n\n```{.r .cell-code}\n# Save the final survey design object\nsaveRDS(w.design0, file = \"data/w.design0.rds\")\n```\n:::\n\n\n\nThis completes the survey design specification section of the statistical analysis stage.\n\n## Chapter Summary and Next Steps\n\nWe have now completed one of the most critical methodological steps in this analysis. By creating a survey design object (`w.design0`), we have properly accounted for the complex stratification, clustering, and weighting of the NHANES data. This ensures that all subsequent analyses will produce statistically valid, nationally representative results.\n\nWith the survey design specified, we are ready to begin our analysis. In the next chapter, \"Descriptive Analysis,\" we will generate the first set of results: weighted summary statistics of our cohort.\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}